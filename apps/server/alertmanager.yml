global:
  resolve_timeout: 5m
  slack_api_url: "https://hooks.slack.com/services/YOUR_SLACK_WEBHOOK_URL" # ğŸš¨ ì‹¤ì œ Slack webhook URLë¡œ êµì²´ í•„ìš”

# ì•Œë¦¼ ë¼ìš°íŒ… ì„¤ì •
route:
  group_by: ["alertname", "service", "severity"]
  group_wait: 10s # ì²« ë²ˆì§¸ ì•Œë¦¼ í›„ 10ì´ˆ ëŒ€ê¸°
  group_interval: 10s # ê·¸ë£¹ ë‚´ ì¶”ê°€ ì•Œë¦¼ì€ 10ì´ˆ ê°„ê²©
  repeat_interval: 1h # ë™ì¼í•œ ì•Œë¦¼ì€ 1ì‹œê°„ë§ˆë‹¤ ë°˜ë³µ
  receiver: "slack-notifications" # ê¸°ë³¸ ìˆ˜ì‹ ì

  # ì‹¬ê°ë„ë³„ ë¼ìš°íŒ…
  routes:
    # Critical ì•Œë¦¼ì€ PagerDutyë¡œ ì¦‰ì‹œ ì „ì†¡
    - match:
        severity: critical
      receiver: "pagerduty-critical"
      continue: true # ë‹¤ë¥¸ ìˆ˜ì‹ ìì—ê²Œë„ ì „ì†¡

    # Warning ì•Œë¦¼ì€ Slackìœ¼ë¡œ ì „ì†¡
    - match:
        severity: warning
      receiver: "slack-notifications"

    # Rate limit ê´€ë ¨ ì•Œë¦¼ì€ ë³„ë„ ì±„ë„ë¡œ ì „ì†¡
    - match:
        alert_type: rate_limit
      receiver: "slack-security"

    # OTP í’ˆì§ˆ ë¬¸ì œëŠ” ê°œë°œíŒ€ ì±„ë„ë¡œ ì „ì†¡
    - match:
        alert_type: otp_quality
      receiver: "slack-development"

    # ì„±ëŠ¥ ë¬¸ì œëŠ” ìš´ì˜íŒ€ ì±„ë„ë¡œ ì „ì†¡
    - match:
        alert_type: performance
      receiver: "slack-operations"

# ìˆ˜ì‹ ì ì •ì˜
receivers:
  # Slack ì¼ë°˜ ì•Œë¦¼
  - name: "slack-notifications"
    slack_configs:
      - channel: "#tango-alerts" # ğŸš¨ ì‹¤ì œ Slack ì±„ë„ëª…ìœ¼ë¡œ êµì²´ í•„ìš”
        title: "ğŸš¨ Tango Server ì•Œë¦¼"
        text: |
          *{{ .GroupLabels.alertname }}*
          *ì„œë¹„ìŠ¤:* {{ .GroupLabels.service }}
          *ì‹¬ê°ë„:* {{ .GroupLabels.severity }}

          {{ range .Alerts }}
          *{{ .Annotations.summary }}*
          {{ .Annotations.description }}

          *ë¼ë²¨:*
          {{ range .Labels.SortedPairs }}
          â€¢ {{ .Name }}: {{ .Value }}
          {{ end }}

          *ëŒ€ì‹œë³´ë“œ:* {{ .Annotations.dashboard }}
          {{ end }}

        # ì•Œë¦¼ ìƒ‰ìƒ ì„¤ì •
        color: '{{ if eq .GroupLabels.severity "critical" }}danger{{ else if eq .GroupLabels.severity "warning" }}warning{{ else }}good{{ end }}'

        # ë²„íŠ¼ ì¶”ê°€
        actions:
          - type: button
            text: "ëŒ€ì‹œë³´ë“œ ë³´ê¸°"
            url: "{{ .Annotations.dashboard }}"

  # Slack ë³´ì•ˆ ì•Œë¦¼ (ë ˆì´íŠ¸ë¦¬ë°‹ ë“±)
  - name: "slack-security"
    slack_configs:
      - channel: "#tango-security" # ğŸš¨ ì‹¤ì œ ë³´ì•ˆ ì±„ë„ëª…ìœ¼ë¡œ êµì²´ í•„ìš”
        title: "ğŸ›¡ï¸ ë³´ì•ˆ ì•Œë¦¼"
        text: |
          *{{ .GroupLabels.alertname }}*
          *ì„œë¹„ìŠ¤:* {{ .GroupLabels.service }}
          *ì‹¬ê°ë„:* {{ .GroupLabels.severity }}

          {{ range .Alerts }}
          *{{ .Annotations.summary }}*
          {{ .Annotations.description }}

          *ë¼ë²¨:*
          {{ range .Labels.SortedPairs }}
          â€¢ {{ .Name }}: {{ .Value }}
          {{ end }}
          {{ end }}

        color: "warning"

  # Slack ê°œë°œíŒ€ ì•Œë¦¼ (OTP í’ˆì§ˆ ë“±)
  - name: "slack-development"
    slack_configs:
      - channel: "#tango-development" # ğŸš¨ ì‹¤ì œ ê°œë°œíŒ€ ì±„ë„ëª…ìœ¼ë¡œ êµì²´ í•„ìš”
        title: "ğŸ”§ ê°œë°œíŒ€ ì•Œë¦¼"
        text: |
          *{{ .GroupLabels.alertname }}*
          *ì„œë¹„ìŠ¤:* {{ .GroupLabels.service }}
          *ì‹¬ê°ë„:* {{ .GroupLabels.severity }}

          {{ range .Alerts }}
          *{{ .Annotations.summary }}*
          {{ .Annotations.description }}

          *ë¼ë²¨:*
          {{ range .Labels.SortedPairs }}
          â€¢ {{ .Name }}: {{ .Value }}
          {{ end }}
          {{ end }}

        color: "good"

  # Slack ìš´ì˜íŒ€ ì•Œë¦¼ (ì„±ëŠ¥ ë“±)
  - name: "slack-operations"
    slack_configs:
      - channel: "#tango-operations" # ğŸš¨ ì‹¤ì œ ìš´ì˜íŒ€ ì±„ë„ëª…ìœ¼ë¡œ êµì²´ í•„ìš”
        title: "âš¡ ìš´ì˜íŒ€ ì•Œë¦¼"
        text: |
          *{{ .GroupLabels.alertname }}*
          *ì„œë¹„ìŠ¤:* {{ .GroupLabels.service }}
          *ì‹¬ê°ë„:* {{ .GroupLabels.severity }}

          {{ range .Alerts }}
          *{{ .Annotations.summary }}*
          {{ .Annotations.description }}

          *ë¼ë²¨:*
          {{ range .Labels.SortedPairs }}
          â€¢ {{ .Name }}: {{ .Value }}
          {{ end }}
          {{ end }}

        color: '{{ if eq .GroupLabels.severity "critical" }}danger{{ else }}warning{{ end }}'

  # PagerDuty Critical ì•Œë¦¼
  - name: "pagerduty-critical"
    pagerduty_configs:
      - service_key: "YOUR_PAGERDUTY_SERVICE_KEY" # ğŸš¨ ì‹¤ì œ PagerDuty service keyë¡œ êµì²´ í•„ìš”
        description: |
          Critical Alert: {{ .GroupLabels.alertname }}
          Service: {{ .GroupLabels.service }}
          Severity: {{ .GroupLabels.severity }}

          {{ range .Alerts }}
          {{ .Annotations.summary }}
          {{ .Annotations.description }}
          {{ end }}

        # PagerDuty ì„¤ì •
        client: "Tango Server Alertmanager"
        client_url: "{{ .Annotations.dashboard }}"

        # ì•Œë¦¼ ê·¸ë£¹í™”
        group_by: ["alertname", "service"]

        # ì•Œë¦¼ ì„¸ë¶€ì‚¬í•­
        details:
          firing: "{{ .Alerts.Firing | len }}"
          status: "{{ .Status }}"
          severity: "{{ .GroupLabels.severity }}"
          service: "{{ .GroupLabels.service }}"

# ì•Œë¦¼ ì–µì œ ì„¤ì •
inhibit_rules:
  # Critical ì—ëŸ¬ìœ¨ì´ ë†’ì„ ë•Œ Warning ì—ëŸ¬ìœ¨ ì•Œë¦¼ ì–µì œ
  - source_match:
      severity: "critical"
      alertname: "CriticalErrorRate"
    target_match:
      severity: "warning"
      alertname: "HighErrorRate"
    equal: ["service"]

  # ì‹¬ê°í•œ ì§€ì—°ì‹œê°„ ë¬¸ì œê°€ ìˆì„ ë•Œ ê²½ê³  ì§€ì—°ì‹œê°„ ì•Œë¦¼ ì–µì œ
  - source_match:
      severity: "critical"
      alertname: "CriticalLatencyP99"
    target_match:
      severity: "warning"
      alertname: "HighLatencyP95"
    equal: ["service"]

  # ë ˆì´íŠ¸ë¦¬ë°‹ ê³¼ë„ ì‚¬ìš© ì‹œ OTP í’ˆì§ˆ ë¬¸ì œ ì•Œë¦¼ ì–µì œ
  - source_match:
      alertname: "HighRateLimitExceeded"
    target_match:
      alert_type: "otp_quality"
    equal: ["service"]

# ì‹œê°„ ê¸°ë°˜ ì•Œë¦¼ ì–µì œ (ì—…ë¬´ì‹œê°„ ì™¸ ì•Œë¦¼ ì œí•œ)
time_intervals:
  - name: workdays
    time_intervals:
      - weekdays: ["monday:friday"]
        times:
          - start_time: 09:00
            end_time: 18:00

  - name: weekends
    time_intervals:
      - weekdays: ["saturday", "sunday"]

  - name: off_hours
    time_intervals:
      - weekdays: ["monday:friday"]
        times:
          - start_time: 18:00
            end_time: 09:00
        location: "Asia/Seoul" # ğŸš¨ ì‹¤ì œ ì‹œê°„ëŒ€ì— ë§ê²Œ ì¡°ì • í•„ìš”
